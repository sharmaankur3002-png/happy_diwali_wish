<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Happy Diwali | Personalized Wishes</title>
  <meta name="theme-color" content="#3b1d5a" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Great+Vibes&family=Playfair+Display:wght@500;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Great+Vibes&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet"></noscript>
  <style>
    :root {
      --bg1: #240046;
      --bg2: #5a189a;
      --bg3: #9d4edd;
      --bg4: #ff8fab;
      --gold: #f8d66d;
      --gold-deep: #d4a72c;
      --maroon: #6b1b2a;
      --orange: #ff7a2f;
      --accent: #ffd7a8;
      --soft: #ffffffcc;
      --white: #fff;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }
    html,
    body {
      max-width: 100vw;
      overflow-x: hidden;
      overflow-y: auto;
      font-family: Poppins, system-ui, Arial, sans-serif;
    }
    body {
      margin: 0;
      color: var(--soft);
      background:
        radial-gradient(1200px 800px at 50% 50%, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0)) fixed,
        linear-gradient(120deg, var(--bg1), var(--bg2), var(--bg3), var(--bg4));
      background-size: 120% 120%, 400% 400%;
      animation: bgShift 20s ease-in-out infinite; /* Slower for perf */
      overflow-x: hidden;
    }
    @keyframes bgShift {
      0%, 100% { background-position: 50% 50%, 0% 50%; }
      50% { background-position: 50% 50%, 100% 50%; }
    }
    .blinking-stars {
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      will-change: transform; /* GPU acceleration */
    }
    .star {
      position: absolute;
      border-radius: 50%;
      background: #ffd700;
      box-shadow: 0 0 8px #ffd700; /* Reduced shadow complexity */
      animation: blink 3s infinite alternate, moveStar 25s linear infinite; /* Slower */
      opacity: .6;
      will-change: transform, opacity;
    }
    @keyframes blink {
      0%, 100% { opacity: .3; }
      50% { opacity: .8; }
    }
    @keyframes moveStar {
      0% { transform: translateY(0) translateX(0); }
      100% { transform: translateY(-100px) translateX(10px); } /* Simple transform */
    }
    #fireworks {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      filter: saturate(1.1); /* Slightly reduced */
    }
    .particles {
      position: fixed;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      background-image: 
        radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, .6) 40%, transparent 41%),
        radial-gradient(1.5px 1.5px at 70% 60%, rgba(255, 255, 255, .4) 40%, transparent 41%),
        radial-gradient(1px 1px at 40% 80%, rgba(255, 255, 255, .3) 40%, transparent 41%);
      animation: drift 40s linear infinite; /* Much slower */
      opacity: .25;
      will-change: transform;
    }
    @keyframes drift {
      0% { transform: translateY(0); }
      100% { transform: translateY(-60px); }
    }
    .floating-diyas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: visible;
      will-change: transform;
    }
    .diya {
      position: absolute;
      bottom: 0;
      left: var(--left);
      width: 35px; /* Slightly smaller */
      height: 50px;
      background: radial-gradient(circle at 50% 25%, #ffdb4d, #cc8c00 80%);
      border-radius: 20px 20px 15px 15px;
      box-shadow: 0 0 10px rgba(255, 195, 50, 0.6); /* Reduced */
      animation: floatUpDown 8s ease-in-out infinite; /* Slower */
      animation-delay: var(--delay);
      filter: drop-shadow(0 0 4px rgba(255, 180, 40, 0.6));
      will-change: transform, opacity;
    }
    @keyframes floatUpDown {
      0% { transform: translateY(100vh); opacity: 0; }
      10% { opacity: .8; }
      90% { opacity: .8; }
      100% { transform: translateY(-10vh); opacity: 0; }
    }
    .diya::before {
      content: "";
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 16px;
      background: radial-gradient(ellipse at center, #fff7ad 0%, #ffa500 70%);
      border-radius: 50% 50% 45% 45%;
      filter: drop-shadow(0 0 4px rgba(255, 240, 150, 0.6));
      animation: flameFlicker 2s ease-in-out infinite alternate; /* Slower */
    }
    @keyframes flameFlicker {
      0% { transform: translateX(-50%) scale(1, 0.95); opacity: 0.8; }
      100% { transform: translateX(-50%) scale(1.05, 1.05); opacity: 1; }
    }
    .topbar {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 30px;
    }
    .brand {
      margin: 0 auto;
      font-family: "Great Vibes", cursive;
      font-size: 56px;
      color: #ffdd94;
      text-shadow: 0 0 8px rgba(255, 215, 100, 0.9);
      text-align: center;
      width: 100%;
      will-change: text-shadow;
    }
    .music-btn {
      background: rgba(255, 255, 255, .12);
      border: 1px solid rgba(255, 255, 255, .2);
      color: var(--white);
      border-radius: 999px;
      padding: 10px 14px;
      cursor: pointer;
      transition: .2s transform ease, .25s background ease;
      box-shadow: var(--shadow);
      will-change: transform;
    }
    .music-btn:hover, .music-btn:active {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .2);
    }
    #app {
      position: relative;
      z-index: 2;
      display: grid;
      place-items: center;
      padding: 24px;
      min-height: calc(100vh - 78px);
    }
    .card {
      width: 92vw;
      max-width: 980px;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
      border: 1px solid rgba(255, 215, 100, 0.4);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 24px;
      backdrop-filter: blur(12px);
      box-sizing: border-box;
      will-change: opacity;
    }
    .title {
      margin: 0 0 12px;
      font-family: "Playfair Display", serif;
      font-weight: 700;
      color: #ffdd94;
      text-shadow: 0 0 8px rgba(255, 215, 100, 0.9);
      letter-spacing: .4px;
      will-change: text-shadow;
    }
    .form {
      display: grid;
      gap: 16px;
      margin-top: 8px;
    }
    .field {
      display: grid;
      gap: 6px;
    }
    .field span {
      font-weight: 600;
      color: #fff7df;
      text-shadow: 0 0 6px rgba(255, 200, 120, 0.8);
    }
    .field input[type="text"],
    .field input[type="file"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .25);
      background: rgba(0, 0, 0, .25);
      color: var(--white);
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s ease; /* Simple transition */
    }
    .hint {
      opacity: .7;
      font-size: 0.9em;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(0, 0, 0, 0.25);
      background: linear-gradient(180deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .05));
      color: #e0ec2c;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: .25s transform ease, .25s background ease;
      box-shadow: 0 0 8px rgba(10, 10, 10, 0.7), inset 0 0 14px rgba(173, 61, 238, 0.9);
      font-weight: 700;
      will-change: transform;
    }
    .btn:hover {
      transform: translateY(-1px);
      background: rgba(252, 249, 249, 0.2);
    }
    .primary {
      border-color: var(--gold-deep);
      background: linear-gradient(180deg, #7a3a9e66, #6b1b2a66);
    }
    .secondary {
      border-color: #ffffff33;
    }
    .share-buttons-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
      align-items: center;
    }
    .share-buttons-container p {
      margin: 0;
      font-weight: 600;
      color: var(--gold);
      text-shadow: 0 0 6px rgba(255, 200, 120, 0.8);
    }
    .share-buttons-container .btn {
      background: linear-gradient(180deg, var(--bg3), var(--bg2));
      color: var(--gold);
      border: 1px solid var(--gold-deep);
      padding: 10px 18px;
      border-radius: 14px;
      font-weight: 700;
      box-shadow: 0 0 12px rgba(248, 214, 109, 0.6);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      text-decoration: none;
      will-change: background, box-shadow;
    }
    .share-buttons-container .btn:hover {
      background: linear-gradient(180deg, var(--bg4), var(--bg3));
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
      color: #fff;
    }
    .hidden {
      display: none;
    }
    .hero {
      display: flex;
      gap: 18px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    .photo-frame {
      position: relative;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: 2px solid var(--gold);
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, .15), rgba(255, 255, 255, 0) 60%);
      box-shadow: 0 0 20px rgba(248, 214, 109, .35), inset 0 0 30px rgba(248, 214, 109, .2);
      overflow: hidden;
      will-change: box-shadow;
    }
    .photo-frame::before {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      border: 6px double rgba(248, 214, 109, .4);
      filter: drop-shadow(0 0 8px rgba(248, 214, 109, .6));
      animation: ringglow 4s ease-in-out infinite; /* Slower */
    }
    @keyframes ringglow {
      0%, 100% { opacity: .5; }
      50% { opacity: .9; }
    }
    .photo-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: contrast(1.05) saturate(1.1);
      will-change: filter;
    }
    @media (max-width:600px) {
      .headline .script { font-size: 40px; }
      .photo-frame { width: 135px; height: 135px; }
      .card { padding: 10px; }
      .brand { font-size: 38px; }
      .diya { width: 25px; height: 35px; } /* Smaller on mobile */
    }
    .diya-float {
      position: absolute;
      bottom: -6px;
      right: -10px;
      width: 64px;
      height: 64px;
      animation: floatUpDown var(--speed, 20s) linear infinite; /* Slower */
    }
    .diya-base {
      position: absolute;
      bottom: 8px;
      left: 8px;
      right: 8px;
      height: 18px;
      border-radius: 14px 14px 6px 6px;
      background: radial-gradient(60% 80% at 50% 40%, #ffb76a, #cc6a28);
      box-shadow: inset 0 4px 10px rgba(0, 0, 0, .25);
    }
    .diya-flame {
      position: absolute;
      bottom: 20px;
      left: 50%;
      width: 16px;
      height: 26px;
      transform: translateX(-50%);
      background: radial-gradient(ellipse at 50% 40%, #fff6a8, #ffb347 55%, rgba(255, 120, 0, 0) 70%);
      border-radius: 50% 50% 50% 50%;
      filter: blur(.2px) drop-shadow(0 0 6px rgba(255, 190, 80, .9));
      animation: flicker 0.5s infinite alternate ease-in-out; /* Optimized */
    }
    @keyframes flicker {
      0% { transform: translateX(-50%) scale(1, .95); }
      100% { transform: translateX(-50%) scale(1.05, 1.05); }
    }
    .headline .script {
      font-family: "Great Vibes", cursive;
      font-size: 48px;
      color: #ffdd94;
      text-shadow: 0 0 8px rgba(255, 215, 100, 0.9);
      margin: 0;
      will-change: text-shadow;
    }
    .sub {
      margin: 6px 0 0;
      font-size: 18px;
      color: #fff7df;
      text-shadow: 0 0 6px rgba(255, 200, 120, 0.8);
    }
    .glow-pulse {
      animation: glowpulse 4s ease-in-out infinite; /* Slower */
    }
    @keyframes glowpulse {
      0%, 100% { text-shadow: 0 0 10px rgba(248, 214, 109, .5); }
      50% { text-shadow: 0 0 18px rgba(248, 214, 109, .9); }
    }
    .greeting {
      margin: 18px 0 0;
    }
    .greeting .line {
      font-size: 20px;
      line-height: 1.6;
      margin: 6px 0;
      opacity: 0;
      color: #fff7df;
      text-shadow: 0 0 6px rgba(255, 200, 120, 0.8);
      will-change: opacity, transform;
    }
    .type {
      animation: typeIn 1s ease forwards;
    }
    .delay-1 { animation-delay: .5s; }
    .delay-2 { animation-delay: 1.1s; }
    .delay-3 { animation-delay: 1.8s; }
    .accent {
      color: var(--accent);
      text-shadow: 0 0 10px rgba(255, 215, 168, .35);
    }
    @keyframes typeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    .foot {
      position: relative;
      z-index: 2;
      text-align: center;
      padding: 16px;
      opacity: .75;
      color: #fff7df;
      text-shadow: 0 0 6px rgba(255, 210, 140, 0.9);
    }
    .warning {
      color: #ffcc00;
      font-size: 14px;
      margin-top: 5px;
    }
    /* Pause animations when tab not visible */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }
    /* Low power mode */
    @media (resolution <= 1dppx) {
      .diya { animation-duration: 12s; }
      .star { animation-duration: 4s, 35s; }
      .particles { animation-duration: 60s; }
    }
  </style>
</head>
<body>
  <canvas id="fireworks" aria-hidden="true" width="1920" height="1080"></canvas> <!-- Fixed size, scale with CSS -->
  <div class="particles" aria-hidden="true"></div>
  <div class="blinking-stars" aria-hidden="true"></div>
  <div class="floating-diyas" aria-hidden="true">
    <div class="diya" style="--left:12vw; --delay:0s;"></div>
    <div class="diya" style="--left:35vw; --delay:3s;"></div>
    <div class="diya" style="--left:60vw; --delay:1.5s;"></div>
    <div class="diya" style="--left:85vw; --delay:4.5s;"></div>
  </div>
  <header class="topbar">
    <h1 class="brand glow-pulse">Happy Diwali</h1>
    <button id="musicToggle" class="music-btn" aria-label="Toggle music" title="Toggle music">üîá</button>
  </header>
  <main id="app">
    <section id="create-view" class="card">
      <h2 class="title">Create Your Wish</h2>
      <form id="create-form" class="form">
        <label class="field">
          <span>Name</span>
          <input id="senderName" type="text" placeholder="Your name" required maxlength="40" />
        </label>
        <label class="field">
          <span>Photo</span>
          <input id="photoInput" type="file" accept="image/*" />
          <small class="hint">Optional. Keep under 500KB for sharing in link. Larger photos show locally only.</small>
          <small class="warning" id="fileWarning" style="display:none;">File too large for sharing (max 500KB). Will display locally.</small>
        </label>
        <div class="actions">
          <button type="submit" class="btn primary">Generate</button>
          <button id="clearForm" type="button" class="btn">Reset</button>
        </div>
      </form>
    </section>
    <section id="greet-view" class="card hidden">
      <div class="hero">
        <div class="photo-frame">
          <img id="recipientPhoto" alt="Sender photo" src="diwali photo.jpg" loading="lazy" />
          <div class="diya-float" aria-hidden="true">
            <div class="diya-base"></div>
            <div class="diya-flame"></div>
          </div>
        </div>
        <div class="headline">
          <h2 class="script glow-pulse">Happy Diwali</h2>
          <p class="sub">From <span id="senderLabel"></span></p>
        </div>
      </div>
      <div class="greeting">
        <p class="line type">üåü May your world be filled with lights of joy,</p>
        <p class="line type delay-1">laughter brighter than diyas ü™î, and</p>
        <p class="line type delay-2">moments sweeter than mithai üç¨!</p>
        <p class="line type delay-3 accent">üíõ Celebrate the sparkle within you ‚Äî this Diwali! üíõ</p>
      </div>
      <div class="actions">
        <button id="createYourOwn" class="btn secondary">Create for You</button>
      </div>
      <div class="share-buttons-container">
        <p>Share your personalised wish:</p>
        <button id="universalShare" class="btn">Share Link üîó</button>
        <a id="waShare" class="btn" target="_blank" rel="noopener">WhatsApp üì±</a>
      </div>
    </section>
  </main>
  <audio id="bgm" loop preload="metadata" src="happy music.mp3"></audio> <!-- metadata only -->
  <footer class="foot">
    <small>Made with lights, joy, and love.</small>
  </footer>
  <script>
    // Throttled resize function
    function throttle(fn, wait) {
      let time = Date.now();
      return function() {
        if ((time + wait - Date.now()) < 0) {
          fn();
          time = Date.now();
        }
      };
    }

    // Optimized stars (fewer, simpler)
    function spawnBlinkingStars() {
      const starDiv = document.querySelector('.blinking-stars');
      starDiv.innerHTML = '';
      const stars = 32; // Reduced from 64
      for (let i = 0; i < stars; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = 2 + Math.random() * 3; // Smaller range
        star.style.width = star.style.height = `${size}px`;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 3}s, ${Math.random() * 30}s`;
        starDiv.appendChild(star);
      }
    }
    spawnBlinkingStars();
    window.addEventListener('resize', throttle(spawnBlinkingStars, 250));

    // Optimized Fireworks (fewer particles, simpler calc)
    (function () {
      const canvas = document.getElementById('fireworks');
      if (!canvas) return;
      const ctx = canvas.getContext('2d', { alpha: true });
      let W = canvas.width, H = canvas.height;
      let dpr = Math.min(1.5, window.devicePixelRatio || 1); // Reduced DPR
      function resize() {
        const rect = canvas.getBoundingClientRect();
        W = canvas.width = rect.width * dpr;
        H = canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
      }
      resize();
      window.addEventListener('resize', throttle(resize, 250));

      const GRAVITY = 0.04; // Slightly increased for faster fall
      const FIREWORKS = [];
      const MAX_PARTICLES = 32; // Reduced from 56
      const MIN_INT = 20; // Slower spawn
      const MAX_INT = 35;

      function spawn(x = Math.random() * window.innerWidth, y = window.innerHeight * 0.3 + Math.random() * window.innerHeight * 0.3) {
        const hue = Math.floor(180 + Math.random() * 180);
        const parts = [];
        for (let i = 0; i < MAX_PARTICLES; i++) {
          const ang = (Math.PI * 2) * (i / MAX_PARTICLES) + (Math.random() - 0.5) * 0.5; // Less random
          const sp = 1.2 + Math.random() * 1.8; // Reduced speed
          parts.push({
            x, y,
            vx: Math.cos(ang) * sp,
            vy: Math.sin(ang) * sp,
            life: 0,
            maxLife: 50 + Math.floor(Math.random() * 25), // Shorter life
            hue,
            size: 0.6 + Math.random() * 1.2 // Smaller
          });
        }
        FIREWORKS.push({ parts });
      }

      let tick = 0;
      let next = Math.floor(MIN_INT + Math.random() * (MAX_INT - MIN_INT));
      let animationId;
      function loop() {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0,0,0,0.1)'; // Less fade for perf
        ctx.fillRect(0, 0, W, H);
        ctx.globalCompositeOperation = 'lighter';

        if (tick % next === 0) {
          spawn();
          if (Math.random() < 0.3) { // Less secondary spawns
            spawn(window.innerWidth * Math.random() * 0.6, window.innerHeight * (0.2 + Math.random() * 0.4));
          }
          next = Math.floor(MIN_INT + Math.random() * (MAX_INT - MIN_INT));
        }
        tick++;

        for (let f = FIREWORKS.length - 1; f >= 0; f--) {
          const fw = FIREWORKS[f];
          let activeParts = 0;
          for (let p of fw.parts) {
            p.life++;
            p.vy += GRAVITY * 0.2; // Simplified
            p.x += p.vx;
            p.y += p.vy;
            const a = Math.max(0, 1 - p.life / p.maxLife);
            if (a > 0) activeParts++;
            const sat = 70 + Math.sin(p.life / 6) * 15; // Simplified sin
            ctx.beginPath();
            ctx.fillStyle = `hsla(${p.hue}, ${sat}%, 60%, ${a * 0.8})`;
            ctx.arc(p.x / dpr, p.y / dpr, p.size, 0, Math.PI * 2); // DPR adjusted
            ctx.fill();
            // Removed inner glow for perf
          }
          fw.parts = fw.parts.filter(p => p.life < p.maxLife);
          if (!fw.parts.length || activeParts === 0) FIREWORKS.splice(f, 1);
        }

        // Pause if tab hidden
        if (document.visibilityState === 'visible') {
          animationId = requestAnimationFrame(loop);
        }
      }
      loop();

      window.addEventListener('click', (e) => {
        if (e.target.closest('button, a, input, label')) return;
        spawn(e.clientX, e.clientY);
      }, { passive: true }); // Passive for perf
    })();

    // Rest of the script remains optimized from previous version
    function getParams() {
      return new URLSearchParams(window.location.search);
    }

    const bgm = document.getElementById('bgm');
    const musicToggle = document.getElementById('musicToggle');
    function setMusicIcon(isOn) { musicToggle.textContent = isOn ? 'üîä' : 'üîá'; }
    function saveMusicPref(isOn) { try { localStorage.setItem('happy_diwali_music', isOn ? '1' : '0'); } catch {} }
    function getMusicPref() { try { return localStorage.getItem('happy_diwali_music') !== '0'; } catch { return true; } }

    async function tryPlayBgm() {
      if (bgm.src && getMusicPref()) {
        try {
          await bgm.play().catch(() => {}); // Silent catch
          setMusicIcon(true);
          saveMusicPref(true);
        } catch (e) {
          setMusicIcon(false);
        }
      } else {
        setMusicIcon(false);
      }
    }

    musicToggle.addEventListener('click', tryPlayBgm, { passive: true });

    // Elements
    const createView = document.getElementById('create-view');
    const greetView = document.getElementById('greet-view');
    const senderNameInput = document.getElementById('senderName');
    const photoInput = document.getElementById('photoInput');
    const fileWarning = document.getElementById('fileWarning');
    const waShare = document.getElementById('waShare');
    const universalShare = document.getElementById('universalShare');
    const clearFormBtn = document.getElementById('clearForm');
    const senderLabel = document.getElementById('senderLabel');
    const recipientPhoto = document.getElementById('recipientPhoto');
    const createYourOwn = document.getElementById('createYourOwn');

    let currentShareUrl = '';
    let currentObjectUrl = null;

    function fileToDataURL(file) {
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = () => rej(new Error('Failed to read file'));
        fr.readAsDataURL(file);
      });
    }

    function sparkleBurst() {
      // Simple sparkle without heavy DOM
      const sparkle = document.createElement('div');
      sparkle.style.cssText = 'position:fixed;top:50%;left:50%;width:0;height:0;border-radius:50%;background:#ffd700;pointer-events:none;z-index:1000;animation:sparkleAnim 0.5s ease-out forwards';
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 500);
    }

    function buildShareUrl({ name, dataUrl }) {
      const u = new URL(window.location.href.split('?')[0]);
      u.searchParams.set('name', encodeURIComponent(name));
      if (dataUrl) u.searchParams.set('img', encodeURIComponent(dataUrl));
      else u.searchParams.delete('img');
      return u.toString();
    }

    function setShareTargets(url, name) {
      currentShareUrl = url;
      const shareText = encodeURIComponent(`${name} is sharing festive cheer with you!%0ALight up your heart this Diwali with positivity and love. ü™î%0ATap here to see your Diwali surprise!`);
      waShare.href = `https://wa.me/?text=${shareText}%0A${encodeURIComponent(url)}`;
    }

    universalShare.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Happy Diwali Personalised Wish',
            text: `${senderNameInput.value.trim()} is sharing festive cheer with you! Light up your heart this Diwali with positivity and love. ü™î`,
            url: currentShareUrl,
          });
        } catch {
          copyShareLinkFallback(currentShareUrl);
        }
      } else {
        copyShareLinkFallback(currentShareUrl);
      }
    });

    function copyShareLinkFallback(url) {
      navigator.clipboard.writeText(url).then(() => {
        const original = universalShare.textContent;
        universalShare.textContent = 'Link Copied! ‚úÖ';
        setTimeout(() => universalShare.textContent = original, 1500);
      }).catch(() => alert('Could not copy: ' + url.substring(0, 50) + '...'));
    }

    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      fileWarning.style.display = file && file.size > 500000 ? 'block' : 'none';
    }, { passive: true });

    document.getElementById('create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = senderNameInput.value.trim();
      if (!name) return senderNameInput.focus();

      const file = photoInput.files?.[0];
      let dataUrlToShare = null;
      let photoSrc = 'diwali photo.jpg';
      let isLargeFile = false;

      if (file) {
        if (file.size <= 500000) {
          dataUrlToShare = await fileToDataURL(file);
          photoSrc = dataUrlToShare;
        } else {
          photoSrc = URL.createObjectURL(file);
          currentObjectUrl = photoSrc;
          isLargeFile = true;
        }
      }

      if (currentObjectUrl && currentObjectUrl !== photoSrc) {
        URL.revokeObjectURL(currentObjectUrl);
      }
      recipientPhoto.src = photoSrc;
      senderLabel.textContent = name;

      const url = buildShareUrl({ name, dataUrl: isLargeFile ? null : dataUrlToShare });
      setShareTargets(url, name);

      createView.classList.add('hidden');
      greetView.classList.remove('hidden');
      sparkleBurst();
    });

    clearFormBtn.addEventListener('click', () => {
      senderNameInput.value = '';
      photoInput.value = '';
      fileWarning.style.display = 'none';
      currentShareUrl = '';
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = null;
      }
      recipientPhoto.src = 'diwali photo.jpg';
      greetView.classList.add('hidden');
      createView.classList.remove('hidden');
    });

    createYourOwn.addEventListener('click', () => {
      greetView.classList.add('hidden');
      createView.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      sparkleBurst();
    });

    function bootFromParams() {
      const params = getParams();
      const name = decodeURIComponent(params.get('name') || '');
      const img = params.get('img') || '';

      if (name) {
        senderLabel.textContent = name;
        createView.classList.add('hidden');
        greetView.classList.remove('hidden');

        if (img.startsWith('data:image/')) {
          try {
            const decodedImg = decodeURIComponent(img);
            recipientPhoto.src = decodedImg;
          } catch {
            recipientPhoto.src = 'diwali photo.jpg';
          }
        } else {
          recipientPhoto.src = 'diwali photo.jpg';
        }

        const url = buildShareUrl({ name, dataUrl: img.startsWith('data:image/') ? decodeURIComponent(img) : null });
        setShareTargets(url, name);
      }

      setMusicIcon(getMusicPref());
    }

    bootFromParams();

    // Music on interaction only
    let hasInteracted = false;
    function handleFirstInteraction() {
      if (!hasInteracted) {
        hasInteracted = true;
        tryPlayBgm();
      }
    }
    ['click', 'touchstart', 'keydown'].forEach(event => {
      document.addEventListener(event, handleFirstInteraction, { once: true, passive: true });
    });

    // Pause animations on visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        bgm.pause();
      } else {
        tryPlayBgm();
      }
    });

    // Add sparkle CSS dynamically
    const style = document.createElement('style');
    style.textContent = '@keyframes sparkleAnim { 0% { transform: scale(0) rotate(0deg); opacity: 1; } 100% { transform: scale(20) rotate(180deg); opacity: 0; } }';
    document.head.appendChild(style);
  </script>
</body>
</html>

